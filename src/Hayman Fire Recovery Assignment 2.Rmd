---
title: "Hayman Fire Recovery"
author: "Kaydee Barker"
date: "1/31/2022"
output: html_document
---

```{r setup, warning=F,message=F}

rm(list=ls()) #clear global environment/workspace

library(tidyverse)
library(tidyr)
library(ggthemes)
library(lubridate)

knitr::opts_knit$set(root.dir='..')
```


```{r dataread, warning=F,message=F}
####-----Reading in Data and Stacking it ----- ####
#Reading in files
files <- list.files('data',full.names=T)


#Read in individual data files
ndmi <- read_csv(files[1]) %>% 
  rename(burned=2,unburned=3) %>%
  mutate(data='ndmi')

ndsi <- read_csv(files[2]) %>% 
  rename(burned=2,unburned=3) %>%
  mutate(data='ndsi')

ndvi <- read_csv(files[3])%>% 
  rename(burned=2,unburned=3) %>%
  mutate(data='ndvi')

# Stack as a tidy dataset
full_long <- rbind(ndvi,ndmi,ndsi) %>%
  gather(key='treatment',value='value',-DateTime,-data) %>%
  filter(!is.na(value))

# another way to do the na on all but the date is to do filter_if(is.numeric, all_vars(!is.na(.)))

# Convert full_long dataset to wide format
full_wide<-spread(full_long,data,value)%>%
  mutate(month=month(DateTime),
         year = year(DateTime))

# Convert to wide with modern syntax, add pre and post burn
full_wide2 <- full_long %>%
  pivot_wider(names_from = data, values_from=value) %>% # determines observation name and value columns
  mutate(year=year(DateTime)) %>%
  mutate(month=month(DateTime)) %>%
  mutate(status = if_else(year < 2002, "pre-burn", "post-burn"))

# Winter only ndsi
ndsi_win <- full_wide2 %>% 
  filter(month %in% c(11,12,1,2,3,4)) %>% 
  group_by(year, treatment) %>%
  summarize(mean_NDSI=mean(ndsi))

# Summer only ndvi
ndvi_sum <- full_wide2 %>% 
  filter(month %in% c(6,7,8,9)) %>% 
  group_by(year, treatment) %>%
  summarize(mean_NDVI=mean(ndvi))

# Make annual dataset, make averages of only summer season
annual <- full_long %>%
  mutate(year=year(DateTime)) %>%
  mutate(month=month(DateTime)) %>%
  filter(month %in% c(5,6,7,8,9)) %>%
  group_by(treatment,year) %>%
  summarise(mean=mean(value))
  
# Join NDVI and NDSI data together
ndvi_ndsi <- inner_join(ndvi_sum, ndsi_win, by = c("year", "treatment")) %>%
  mutate(Status = if_else(year < 2002, "pre-burn", "post-burn")) 


```

```{r, warning = FALSE, message=F}

#ggplot of full dataset
ggplot(data = full_long, aes(x=DateTime,y=value, color=treatment)) + 
  geom_point(shape=1) + 
  geom_line() +
  xlab("Date") + ylab(expression(paste("NDVI"))) +
  ggtitle("Burned and Unburned") +
  theme_few(base_size = 16) +
  scale_color_brewer(palette = "Accent") +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), legend.position="bottom")

#ggplot of annual means
ggplot(data = annual, aes(x=year,y=mean, color=treatment)) + 
  geom_point(shape=1) + 
  geom_line() +
  xlab("Date") + ylab(expression(paste("NDVI"))) +
  ggtitle("Burned and Unburned") +
  theme_few(base_size = 16) +
  scale_color_brewer(palette = "Accent") +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), legend.position="bottom")

```


## Question 1

What is the correlation between NDVI and NDMI? - here I want you to
convert the full_long dataset in to a wide dataset using the 
function "spread" and then make a plot that shows the correlation as a
function of if the site was burned or not (x axis should be ndmi)
You should exclude winter months and focus on summer months

```{r, warning = FALSE, message=F}

#ggplot of wide set in summer
full_wide %>%
  filter(month %in% c(6,7,8,9,10)) %>%
ggplot(., aes(x=ndmi,y=ndvi, color=treatment)) + 
  geom_point(shape=1) + 
  xlab("NDMI") + ylab("NDVI") +
  ggtitle("Burned and Unburned") +
  theme_few(base_size = 16) +
  scale_color_brewer(palette = "Set2") +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), legend.position="bottom")

```

## Question 2 

What is the correlation between average NDSI (normalized
 snow index) for January - April and average NDVI for June-August?
In other words, does the previous year's snow cover influence vegetation
 growth for the following summer?

```{r, warning = FALSE, message=F, fig.height= 6, fig.width= 5, fig.align='center'}

#ggplot winter NDSI to summer NDVI
ggplot(ndvi_ndsi, aes(x = mean_NDVI, y = mean_NDSI)) +
  geom_point(fill = "blue", 
             shape = 21, 
             size = 2) +
  geom_smooth(method = "lm",
              se = TRUE,
              lty = 1,
              color = "black",
              fill = "lightgrey",
              size = 1) +
  xlab("Mean NDSI") + ylab("Mean NDVI") +
  ggtitle("Winter NDSI vs. Summer NDVI") +
  theme_few(base_size = 16) +
  scale_y_continuous(breaks = pretty(c(-0.4,0.5), n = 4)) +
  scale_x_continuous(breaks = pretty(c(0.2,0.5), n = 6)) +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), legend.position="bottom")

```

## Question 3

How is the snow effect from question 2 different between pre- and post-burn
and burned and unburned? 

```{r, warning = FALSE, message=F, fig.height= 6, fig.width= 5, fig.align='center'}

par(mfrow=c(2,1)) # put graphs side by side

ggplot(ndvi_ndsi, aes(x = mean_NDVI, y = mean_NDSI, color = treatment)) +
  geom_point(shape = 21, 
             size = 2) +
  geom_smooth(method = "lm",
              se = TRUE,
              lty = 1,
              color = "black",
              size = 1) +
  xlab("Mean NDSI") + ylab("Mean NDVI") +
  ggtitle("NDSI vs. NDVI in Burned and Unburned Plots") +
  theme_few(base_size = 16) +
  scale_y_continuous(breaks = pretty(c(-0.4,0.5), n = 4)) +
  scale_x_continuous(breaks = pretty(c(0.2,0.5), n = 6)) +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), legend.position="bottom")

```

## Question 4

What month is the greenest month on average? 

```{r, warning = FALSE, message=F}



```


## Question 5) 

What month is the snowiest on average?

```{r, warning = FALSE, message=F}



```

## Bonus Question: Redo all problems with `spread` and `gather` using modern tidyverse syntax. 


## Bonus Question: Use Climate Engine to pull the same data for the assignment, but updated with 2020/2021 data.




